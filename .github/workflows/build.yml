name: Build Mi6 postmarketOS Docker Image

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: System Environment Setup
        run: |
          sudo apt-get update
          # 核心修复：添加 binfmt-support 以获取 update-binfmts 命令
          # 添加 git, openssl, fastboot, qemu 等基础构建工具
          sudo apt-get install -y \
            python3 \
            git \
            openssl \
            fastboot \
            qemu-user-static \
            binfmt-support \
            wget
          
          # 2026年环境自检：确保宿主机支持并注册 aarch64 模拟
          sudo update-binfmts --enable qemu-aarch64 || echo "binfmt already enabled"

      - name: Install pmbootstrap from Source
        run: |
          # 克隆官方最新源码，绕过 pip 环境限制
          git clone --depth 1 https://gitlab.com/postmarketOS/pmbootstrap.git
          # 获取绝对路径并设置权限
          PMB_PATH=$(pwd)/pmbootstrap/pmbootstrap.py
          chmod +x $PMB_PATH
          # 建立软链接到系统路径
          sudo ln -sf $PMB_PATH /usr/local/bin/pmbootstrap
          # 验证安装
          pmbootstrap --version

      - name: Initialize pmbootstrap (Non-Interactive)
        run: |
          # 2026版 pmbootstrap 初始化：指定路径并静默配置
          # 针对小米6 (sagit) 开启 systemd
          mkdir -p /home/runner/.local/share/pmbootstrap
          pmbootstrap init --path /home/runner/.local/share/pmbootstrap <<EOF
          edge
          xiaomi
          sagit
          y
          user
          console
          systemd
          n
          EOF

      - name: Build Rootfs with Docker
        run: |
          # 核心步骤：预装 docker 并扩展分区大小
          # --no-fde 跳过磁盘加密，方便作为服务器使用
          pmbootstrap install --extra-packages docker,docker-compose,nano,htop --no-fde --size 4096

      - name: Export and Compress Images
        run: |
          # 导出镜像至常用格式
          pmbootstrap export
          mkdir -p output
          # 2026年文件名规则匹配
          cp /tmp/postmarketOS-export/boot.img* output/ || true
          cp /tmp/postmarketOS-export/xiaomi-sagit.img* output/ || true

      - name: Upload Build Result
        uses: actions/upload-artifact@v4
        with:
          name: Mi6-Docker-OS-Final
          path: output/
