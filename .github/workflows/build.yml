name: Build Mi6 postmarketOS Docker Image

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: System Environment Setup
        run: |
          sudo apt-get update
          # 安装构建所需的系统工具
          sudo apt-get install -y \
            python3 \
            git \
            openssl \
            fastboot \
            qemu-user-static \
            binfmt-support \
            wget
          
          # 注册 aarch64 模拟支持
          sudo update-binfmts --enable qemu-aarch64 || echo "binfmt already enabled"

      - name: Install pmbootstrap from Source (New Domain)
        run: |
          # 核心修复：使用迁移后的官方新域名 gitlab.postmarketos.org
          git clone --depth 1 https://gitlab.postmarketos.org/postmarketOS/pmbootstrap.git
          
          # 获取绝对路径并设置执行权限
          PMB_PATH=$(pwd)/pmbootstrap/pmbootstrap.py
          chmod +x $PMB_PATH
          
          # 建立系统软链接
          sudo ln -sf $PMB_PATH /usr/local/bin/pmbootstrap
          
          # 验证安装是否成功
          pmbootstrap --version

      - name: Initialize pmbootstrap (Non-Interactive)
        run: |
          # 确保缓存目录存在
          mkdir -p /home/runner/.local/share/pmbootstrap
          
          # 针对小米6 (sagit) 进行静默初始化
          # 2026年策略：使用 edge 分支以获取最新的 Docker 兼容内核
          pmbootstrap init --path /home/runner/.local/share/pmbootstrap <<EOF
          edge
          xiaomi
          sagit
          y
          user
          console
          systemd
          n
          EOF

      - name: Build Rootfs with Docker
        run: |
          # --extra-packages 预装 docker 环境
          # --size 4096 确保刷入 userdata 后有足够空间
          # --no-fde 关闭全盘加密，防止老设备启动缓慢
          pmbootstrap install --extra-packages docker,docker-compose,nano,htop --no-fde --size 4096

      - name: Export and Compress Images
        run: |
          # 导出镜像
          pmbootstrap export
          mkdir -p output
          # 兼容不同的导出文件名后缀
          cp /tmp/postmarketOS-export/boot.img* output/ || true
          cp /tmp/postmarketOS-export/xiaomi-sagit.img* output/ || true

      - name: Upload Build Result
        uses: actions/upload-artifact@v4
        with:
          name: Mi6-Docker-OS-Final
          path: output/
