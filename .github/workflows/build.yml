name: Build Mi6 postmarketOS Docker Image

on:
  workflow_dispatch:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: System Environment Setup
        run: |
          sudo apt-get update
          # 安装构建所需的系统工具以及 binfmt-support, expect
          sudo apt-get install -y \
            python3 \
            git \
            openssl \
            fastboot \
            qemu-user-static \
            binfmt-support \
            wget \
            expect
          
          # 注册 aarch64 模拟支持
          sudo update-binfmts --enable qemu-aarch64 || echo "binfmt already enabled"

      - name: Install pmbootstrap from Source (Correct Domain)
        run: |
          # 修复：使用官方新域名 gitlab.postmarketos.org
          git clone --depth 1 https://gitlab.postmarketos.org/postmarketOS/pmbootstrap.git
          
          # 设置软链接
          PMB_PATH=$(pwd)/pmbootstrap/pmbootstrap.py
          chmod +x $PMB_PATH
          sudo ln -sf $PMB_PATH /usr/local/bin/pmbootstrap
          
          # 验证版本
          pmbootstrap --version

      - name: Initialize pmbootstrap (Direct Config)
        run: |
          mkdir -p ~/.config ~/.local/var/pmbootstrap/cache_git
          touch build.log

          # 1. 克隆 pmaports (master 分支，包含 edge 设备)
          echo "=== Step 1: Cloning pmaports ===" >> build.log
          git clone --depth=1 https://gitlab.postmarketos.org/postmarketOS/pmaports.git \
              ~/.local/var/pmbootstrap/cache_git/pmaports >> build.log 2>&1
          echo "pmaports cloned successfully" >> build.log

          # 2. 直接生成完整配置文件 (无需 init 交互)
          # 根据 pmb/core/config.py 源码，配置文件为 INI 格式
          echo "=== Step 2: Generating config file ===" >> build.log
          cat <<EOF > ~/.config/pmbootstrap_v3.cfg
          [pmbootstrap]
          device = xiaomi-sagit
          ui = fbkeyboard
          work = /home/runner/.local/var/pmbootstrap
          hostname = mi6
          user = user
          systemd = default
          extra_packages = docker,docker-compose,nano,htop
          is_default_channel = False
          aports = /home/runner/.local/var/pmbootstrap/cache_git/pmaports
          EOF

          echo "Config file content:" >> build.log
          cat ~/.config/pmbootstrap_v3.cfg >> build.log

          # 3. 初始化工作目录结构 (work_version = 8，来自 pmb/config/__init__.py)
          echo "=== Step 3: Initializing work directory ===" >> build.log
          mkdir -p ~/.local/var/pmbootstrap
          echo "8" > ~/.local/var/pmbootstrap/version
          echo "work directory initialized with version 8" >> build.log

          # 4. 验证配置是否被正确读取
          echo "=== Step 4: Verifying config ===" >> build.log
          pmbootstrap status >> build.log 2>&1 || echo "pmbootstrap status failed (expected if first run)" >> build.log

      - name: Build Rootfs with Docker (TWRP Zip)
        run: |
          set -o pipefail
          # --add: 预装包 (精简版)
          #   - docker,docker-compose,nano,htop: 用户需求
          # UI: fbkeyboard (Framebuffer 虚拟键盘，极致轻量)
          # --password: CI 自动化安装时使用的虚拟密码
          # --android-recovery-zip: 生成 TWRP 可直接刷入的 zip 包
          pmbootstrap install \
            --add docker,docker-compose,nano,htop \
            --password changeme \
            --android-recovery-zip \
            2>&1 | tee -a build.log
          
          # 禁用 NTP 时间同步等待服务 (避免启动卡住)
          echo "Disabling time-wait-sync service..." >> build.log
          pmbootstrap chroot -- systemctl disable systemd-time-wait-sync.service 2>&1 | tee -a build.log || true
          pmbootstrap chroot -- systemctl mask systemd-time-wait-sync.service 2>&1 | tee -a build.log || true

      - name: Upload Build Log on Failure
        if: failure()
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # 1. 先提交本地修改 (解决 unstaged changes 错误)
          git add --force build.log
          git commit -m "ci: build failure log [skip ci]"
          
          # 2. 再拉取远程更新 (rebase)
          git pull --rebase
          
          # 3. 推送
          git push

      - name: Export and Compress Images
        run: |
          # 导出镜像
          pmbootstrap export
          mkdir -p output
          # 兼容导出文件
          cp -r /tmp/postmarketOS-export/* output/

      - name: Upload Build Result
        uses: actions/upload-artifact@v4
        with:
          name: Mi6-Docker-OS-Final
          path: output/
