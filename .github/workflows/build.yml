name: Build Mi6 postmarketOS Docker Image

on:
  workflow_dispatch:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: System Environment Setup
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3 \
            git \
            openssl \
            fastboot \
            qemu-user-static \
            binfmt-support \
            wget \
            expect
          sudo update-binfmts --enable qemu-aarch64 || echo "binfmt already enabled"

      # ========== 优化后的缓存配置 ==========
      - name: Cache pmbootstrap work directory
        uses: actions/cache@v4
        with:
          path: |
            /home/runner/.local/var/pmbootstrap/cache_git
            /home/runner/.local/var/pmbootstrap/packages
            /home/runner/.local/var/pmbootstrap/cache_distfiles
          # 使用 APKBUILD 的 hash 作为 key，只要内核配置没变，缓存就有效
          key: pmbootstrap-v2-${{ runner.os }}-${{ hashFiles('**/APKBUILD') }}
          restore-keys: |
            pmbootstrap-v2-${{ runner.os }}-

      # ========== 修复缓存恢复后的权限问题 ==========
      - name: Fix Restored Cache Permissions
        run: |
          echo "=== Fixing permissions for restored cache ==="
          # 如果缓存恢复了 packages 目录，需要确保 pmbootstrap 可以写入
          if [ -d /home/runner/.local/var/pmbootstrap/packages ]; then
            sudo chmod -R 777 /home/runner/.local/var/pmbootstrap/packages
            echo "Fixed packages directory permissions"
          fi
          if [ -d /home/runner/.local/var/pmbootstrap/cache_git ]; then
            sudo chmod -R 777 /home/runner/.local/var/pmbootstrap/cache_git
            echo "Fixed cache_git directory permissions"
          fi

      - name: Install pmbootstrap from Source
        run: |
          git clone --depth 1 https://gitlab.postmarketos.org/postmarketOS/pmbootstrap.git
          PMB_PATH=$(pwd)/pmbootstrap/pmbootstrap.py
          chmod +x $PMB_PATH
          sudo ln -sf $PMB_PATH /usr/local/bin/pmbootstrap
          pmbootstrap --version

      - name: Initialize pmbootstrap (Direct Config)
        run: |
          mkdir -p ~/.config ~/.local/var/pmbootstrap/cache_git
          touch build.log

          echo "=== Step 1: Setting up pmaports ===" >> build.log
          PMAPORTS_DIR=~/.local/var/pmbootstrap/cache_git/pmaports
          if [ -d "$PMAPORTS_DIR" ]; then
            echo "pmaports exists (from cache), updating..." >> build.log
            cd "$PMAPORTS_DIR" && git pull --rebase >> build.log 2>&1 || true
            cd -
          else
            echo "Cloning pmaports..." >> build.log
            git clone --depth=1 https://gitlab.postmarketos.org/postmarketOS/pmaports.git \
                "$PMAPORTS_DIR" >> build.log 2>&1
          fi
          
          echo "=== Step 1.5: Patching deviceinfo for RNDIS ===" >> build.log
          DEVICEINFO_PATH="$PMAPORTS_DIR/device/testing/device-xiaomi-sagit/deviceinfo"
          # 避免重复添加
          grep -q "rndis.usb0" "$DEVICEINFO_PATH" || echo 'deviceinfo_usb_network_function="rndis.usb0"' >> "$DEVICEINFO_PATH"
          
          echo "=== Step 2: Generating config file ===" >> build.log
          cat <<EOF > ~/.config/pmbootstrap_v3.cfg
          [pmbootstrap]
          device = xiaomi-sagit
          ui = console
          work = /home/runner/.local/var/pmbootstrap
          hostname = mi6
          user = user
          systemd = never
          extra_packages = docker,docker-compose,nano,htop
          is_default_channel = False
          aports = /home/runner/.local/var/pmbootstrap/cache_git/pmaports
          EOF

          echo "8" > ~/.local/var/pmbootstrap/version

      - name: Patch and Rebuild Kernel
        run: |
          BUILD_LOG="$GITHUB_WORKSPACE/build.log"
          PMAPORTS=~/.local/var/pmbootstrap/cache_git/pmaports
          KERNEL_PKG_DIR="$PMAPORTS/device/testing/linux-postmarketos-qcom-msm8998"
          
          cd "$KERNEL_PKG_DIR"
          
          # 检查是否已经补丁过，防止重复注入
          if ! grep -q "fix_memory_map" APKBUILD; then
            echo '' >> APKBUILD
            echo '# === WiFi/ADSP/MPSS Memory Fix ===' >> APKBUILD
            echo 'fix_memory_map() {' >> APKBUILD
            echo $'\tmsg "Applying FINAL MEMORY MAP fix..."' >> APKBUILD
            echo $'\t# 动态查找 DTS 文件，防止路径错误' >> APKBUILD
            echo $'\tlocal DTS_FILE=$(find . -name "msm8998-xiaomi-sagit.dts" | head -n 1)' >> APKBUILD
            echo $'\tif [ -z "$DTS_FILE" ]; then' >> APKBUILD
            echo $'\t\terror "ERROR: msm8998-xiaomi-sagit.dts NOT FOUND in $(pwd)"' >> APKBUILD
            echo $'\t\treturn 1' >> APKBUILD
            echo $'\tfi' >> APKBUILD
            echo $'\tmsg "Found DTS file at: $DTS_FILE"' >> APKBUILD
            echo $'\tmsg "Checking file BEFORE modification:"' >> APKBUILD
            echo $'\tls -l "$DTS_FILE"' >> APKBUILD
            echo $'\tmd5sum "$DTS_FILE"' >> APKBUILD
            echo $'\tgrep "8b200000" "$DTS_FILE" || msg "WARNING: 8b200000 not found!"' >> APKBUILD
            
            echo $'\tmsg "Executing Memory Map Fix (Strategy: Delete & Append)..."' >> APKBUILD
            
            # --- 策略: 删除旧节点引用 + 追加新定义 ---
            # 这种方法不依赖旧值的具体写法，也不会产生冲突
            
            # 1. 在文件开头(或 reserved-memory 之前) 删除旧引用
            # 注意：sed 在 reserved-memory { 之前插入 delete-node 语句
            echo $'\tsed -i "/reserved-memory {/i \\/delete-node/ &adsp_mem;\\n/delete-node/ &wlan_msa_mem;\\n" "$DTS_FILE"' >> APKBUILD
            
            # 2. 追加新定义
            echo $'\t\tsed -i "/reserved-memory {/a \\' >> APKBUILD
            echo $'\t\t\t\t\\ \\ \\ \\ \\ \\ \\ \\ adsp_mem: memory@91900000 {\\n\\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ reg = <0x0 0x91900000 0x0 0x1e00000>;\\n\\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ no-map;\\n\\ \\ \\ \\ \\ \\ \\ \\ };\\n\\ \\ \\ \\ \\ \\ \\ \\ wlan_msa_mem: memory@95800000 {\\n\\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ reg = <0x0 0x95800000 0x0 0x100000>;\\n\\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ \\ no-map;\\n\\ \\ \\ \\ \\ \\ \\ \\ };" "$DTS_FILE"' >> APKBUILD
            
            # --- 验证 (检查新地址是否存在) ---
            echo $'\tif grep -q "91900000" "$DTS_FILE"; then' >> APKBUILD
            echo $'\t\tmsg "FINAL VERIFICATION SUCCESS: New adsp_mem definition found."' >> APKBUILD
            echo $'\telse' >> APKBUILD
            echo $'\t\terror "FINAL VERIFICATION FAILED: Fix NOT applied! Context dump:"' >> APKBUILD
            echo $'\t\tgrep -C 10 "reserved-memory" "$DTS_FILE" | head -n 30' >> APKBUILD
            echo $'\t\treturn 1' >> APKBUILD
            echo $'\tfi' >> APKBUILD
            
            echo $'\tmsg "Memory map fix applied and verified"' >> APKBUILD
            echo '}' >> APKBUILD
            sed -i '/default_prepare/a\	fix_memory_map' APKBUILD
          fi
          
          # 使用正则匹配任意 pkgrel 值
          sed -i 's/pkgrel=[0-9]*/pkgrel=10/' APKBUILD
          
          pmbootstrap checksum linux-postmarketos-qcom-msm8998 2>&1 | tee -a "$BUILD_LOG"
          # 去掉 --force，pmbootstrap 会自动检查是否需要重新编译
          pmbootstrap --details-to-stdout build linux-postmarketos-qcom-msm8998 2>&1 | tee -a "$BUILD_LOG"

      - name: Build Rootfs with Docker (TWRP Zip)
        run: |
          set -o pipefail
          pmbootstrap install \
            --add docker,docker-compose,nano,htop,firmware-xiaomi-sagit,pd-mapper,tqftpserv,qrtr,rmtfs,msm-modem,ofono,android-tools \
            --password zhoutong \
            --android-recovery-zip \
            2>&1 | tee -a build.log
          
          # 注入固件
          FIRMWARE_URL="https://git.kernel.org/pub/scm/linux/kernel/git/firmware/linux-firmware.git/plain/ath10k/WCN3990/hw1.0/firmware-5.bin"
          wget -O /tmp/firmware-5.bin "$FIRMWARE_URL" || true
          
          pmbootstrap chroot -r -- mkdir -p /lib/firmware/ath10k/WCN3990/hw1.0/
          WORK_DIR=$(pmbootstrap config work)
          cp /tmp/firmware-5.bin "$WORK_DIR/chroot_rootfs_xiaomi-sagit/tmp/" || true
          pmbootstrap chroot -r -- cp /tmp/firmware-5.bin /lib/firmware/ath10k/WCN3990/hw1.0/firmware-5.bin || true
          
          # 服务启用
          pmbootstrap chroot -r -- rc-update add adbd default || true
          pmbootstrap chroot -r -- rc-update del sleep-inhibitor default || true

      - name: Export and Compress Images
        run: |
          pmbootstrap export
          mkdir -p output
          cp -r /tmp/postmarketOS-export/* output/

      - name: Upload Build Result
        uses: actions/upload-artifact@v4
        with:
          name: Mi6-Docker-OS-Final
          path: output/

      - name: Upload Boot Image (TWRP Flashable)
        uses: actions/upload-artifact@v4
        with:
          name: Mi6-Boot-Image-Fixed
          path: output/boot.img

      # ========== 核心修复：准备缓存阶段 ==========
      - name: Prepare Cache Permissions
        if: always()
        run: |
          echo "=== Cleaning up and fixing permissions for cache ==="
          # 1. 卸载所有还在挂载的目录 (pmbootstrap 有时会残留挂载)
          sudo pmbootstrap shutdown || true
          # 2. 修改工作目录所有权，让 runner 用户可以打包它
          sudo chown -R runner:runner /home/runner/.local/var/pmbootstrap || true
          # 3. 删除巨大的 chroot 目录以节省空间
          find /home/runner/.local/var/pmbootstrap -maxdepth 1 -name "chroot_*" -type d -exec sudo rm -rf {} + || true

      - name: Upload Build Log on Failure
        if: failure()
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add --force build.log
          git commit -m "ci: build failure log [skip ci]"
          git pull --rebase
          git push
