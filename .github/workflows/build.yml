name: Build Mi6 postmarketOS Docker Image

on:
  workflow_dispatch:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: System Environment Setup
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3 \
            git \
            openssl \
            fastboot \
            qemu-user-static \
            binfmt-support \
            wget \
            expect \
            ccache
          sudo update-binfmts --enable qemu-aarch64 || echo "binfmt already enabled"

      # 获取 pmaports 最新提交 Hash 用于缓存控制
      - name: Get pmaports Hash
        id: get-hash
        run: |
          HASH=$(git ls-remote https://gitlab.postmarketos.org/postmarketOS/pmaports.git main | awk '{print $1}')
          echo "pmaports_hash=$HASH" >> $GITHUB_OUTPUT
          # 计算当前周数，用于 ccache key（同一周内可以复用缓存）
          WEEK=$(date +%Y-W%V)
          echo "week_number=$WEEK" >> $GITHUB_OUTPUT

      # ========== 优化后的 pmbootstrap 缓存 ==========
      - name: Cache pmbootstrap work directory
        uses: actions/cache@v4
        with:
          path: |
            /home/runner/.local/var/pmbootstrap/cache_git
            /home/runner/.local/var/pmbootstrap/packages
            /home/runner/.local/var/pmbootstrap/cache_distfiles
          # 使用 pmaports 的 hash 作为 key，确保代码更新时能部分重用
          # v5: 强制清理之前被污染的缓存
          key: pmb-v5-${{ runner.os }}-${{ steps.get-hash.outputs.pmaports_hash }}
          restore-keys: |
            pmb-v5-${{ runner.os }}-

      # ========== ccache 编译缓存 ==========
      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: /home/runner/.cache/ccache
          # 使用周数作为 key，同一周内可以复用缓存
          key: ccache-v3-${{ runner.os }}-sagit-${{ steps.get-hash.outputs.week_number }}
          restore-keys: |
            ccache-v3-${{ runner.os }}-sagit-
            ccache-v3-${{ runner.os }}-

      - name: Setup ccache
        run: |
          mkdir -p /home/runner/.cache/ccache
          ccache --set-config=max_size=2G
          ccache --set-config=compression=true
          # 显示 ccache 统计
          echo "=== ccache stats before build ==="
          ccache -s

      # ========== 修复缓存恢复后的权限问题 ==========
      - name: Fix Restored Cache Permissions
        run: |
          echo "=== Fixing permissions for restored cache ==="
          # 如果缓存恢复了 packages 目录，需要确保 pmbootstrap 可以写入
          if [ -d /home/runner/.local/var/pmbootstrap/packages ]; then
            sudo chmod -R 777 /home/runner/.local/var/pmbootstrap/packages
            echo "Fixed packages directory permissions"
          fi
          if [ -d /home/runner/.local/var/pmbootstrap/cache_git ]; then
            sudo chmod -R 777 /home/runner/.local/var/pmbootstrap/cache_git
            echo "Fixed cache_git directory permissions"
          fi

      - name: Install pmbootstrap from Source
        run: |
          git clone --depth 1 https://gitlab.postmarketos.org/postmarketOS/pmbootstrap.git
          PMB_PATH=$(pwd)/pmbootstrap/pmbootstrap.py
          chmod +x $PMB_PATH
          sudo ln -sf $PMB_PATH /usr/local/bin/pmbootstrap
          pmbootstrap --version

      - name: Initialize pmbootstrap (Direct Config)
        run: |
          mkdir -p ~/.config ~/.local/var/pmbootstrap/cache_git

          echo "=== Step 1: Setting up pmaports ==="
          PMAPORTS_DIR=~/.local/var/pmbootstrap/cache_git/pmaports
          if [ -d "$PMAPORTS_DIR" ]; then
            echo "pmaports exists (from cache), updating..."
            cd "$PMAPORTS_DIR" && git pull --rebase 2>&1 || true
            cd -
          else
            echo "Cloning pmaports..."
            git clone --depth=1 https://gitlab.postmarketos.org/postmarketOS/pmaports.git \
                "$PMAPORTS_DIR" 2>&1
          fi
          
          echo "=== Step 1.5: Patching deviceinfo for RNDIS ==="
          DEVICEINFO_PATH="$PMAPORTS_DIR/device/testing/device-xiaomi-sagit/deviceinfo"
          # 避免重复添加
          grep -q "rndis.usb0" "$DEVICEINFO_PATH" || echo 'deviceinfo_usb_network_function="rndis.usb0"' >> "$DEVICEINFO_PATH"
          
          echo "=== Step 2: Generating config file ==="
          # 使用 echo 命令避免 YAML 缩进产生的前导空格问题
          mkdir -p ~/.config
          echo "[pmbootstrap]" > ~/.config/pmbootstrap_v3.cfg
          echo "device = xiaomi-sagit" >> ~/.config/pmbootstrap_v3.cfg
          echo "ui = console" >> ~/.config/pmbootstrap_v3.cfg
          echo "work = /home/runner/.local/var/pmbootstrap" >> ~/.config/pmbootstrap_v3.cfg
          echo "hostname = mi6" >> ~/.config/pmbootstrap_v3.cfg
          echo "user = user" >> ~/.config/pmbootstrap_v3.cfg
          echo "systemd = never" >> ~/.config/pmbootstrap_v3.cfg
          echo "extra_packages = docker,docker-compose,nano,htop" >> ~/.config/pmbootstrap_v3.cfg
          echo "is_default_channel = False" >> ~/.config/pmbootstrap_v3.cfg
          echo "aports = /home/runner/.local/var/pmbootstrap/cache_git/pmaports" >> ~/.config/pmbootstrap_v3.cfg
          echo "ccache = /home/runner/.cache/ccache" >> ~/.config/pmbootstrap_v3.cfg
          
          # 验证配置文件内容
          echo "=== pmbootstrap config file ===" 
          cat ~/.config/pmbootstrap_v3.cfg

          echo "8" > ~/.local/var/pmbootstrap/version

      - name: Patch and Rebuild Kernel
        run: |
          PMAPORTS=~/.local/var/pmbootstrap/cache_git/pmaports
          KERNEL_PKG_DIR="$PMAPORTS/device/testing/linux-postmarketos-qcom-msm8998"
          
          cd "$KERNEL_PKG_DIR"
          
          # 检查是否已经补丁过，防止重复注入
          if ! grep -q "fix_memory_map" APKBUILD; then
            echo '' >> APKBUILD
            echo '# === WiFi/ADSP/MPSS Memory Fix ===' >> APKBUILD
            echo 'fix_memory_map() {' >> APKBUILD
            echo $'\tmsg "========== MEMORY MAP FIX START =========="' >> APKBUILD
            echo $'\tmsg "Initial directory: $(pwd)"' >> APKBUILD
            echo $'\tls -la' >> APKBUILD
            
            # 关键：进入解压后的内核源码目录
            # 注意：[ -d "linux-"* ] 语法在 shell 中是错误的，使用 ls -d 代替
            echo $'\t# 进入解压后的内核源码目录（通常是 linux-* 或 src/linux-*）' >> APKBUILD
            echo $'\tif ls -d linux-*/ >/dev/null 2>&1; then' >> APKBUILD
            echo $'\t\tcd linux-*/' >> APKBUILD
            echo $'\t\tmsg "Changed to kernel source dir: $(pwd)"' >> APKBUILD
            echo $'\telif ls -d src/linux-*/ >/dev/null 2>&1; then' >> APKBUILD
            echo $'\t\tcd src/linux-*/' >> APKBUILD
            echo $'\t\tmsg "Changed to kernel source dir: $(pwd)"' >> APKBUILD
            echo $'\telse' >> APKBUILD
            echo $'\t\tmsg "WARNING: Could not find linux-* directory, staying in $(pwd)"' >> APKBUILD
            echo $'\t\tmsg "Directory contents:"' >> APKBUILD
            echo $'\t\tls -la' >> APKBUILD
            echo $'\tfi' >> APKBUILD
            
            echo $'\tmsg "Listing DTS/DTSI files in qcom:"' >> APKBUILD
            echo $'\tfind . -name "*.dts*" -path "*qcom*" 2>/dev/null | head -20' >> APKBUILD
            
            # 查找 DTSI 文件
            echo $'\tlocal DTSI_FILE=$(find . -name "msm8998.dtsi" 2>/dev/null | head -n 1)' >> APKBUILD
            echo $'\tmsg "DTSI_FILE found: $DTSI_FILE"' >> APKBUILD
            echo $'\tif [ -z "$DTSI_FILE" ]; then' >> APKBUILD
            echo $'\t\terror "ERROR: msm8998.dtsi NOT FOUND!"' >> APKBUILD
            echo $'\t\tmsg "All dtsi files:"' >> APKBUILD
            echo $'\t\tfind . -name "*.dtsi" 2>/dev/null | head -30' >> APKBUILD
            echo $'\t\treturn 1' >> APKBUILD
            echo $'\tfi' >> APKBUILD
            echo $'\tmsg "Found DTSI file at: $DTSI_FILE"' >> APKBUILD
            echo $'\tmsg "File size: $(wc -c < \"$DTSI_FILE\") bytes"' >> APKBUILD
            
            # 调试：显示 DTSI 中包含 adsp_mem 的行
            echo $'\tmsg "Lines containing adsp_mem in DTSI:"' >> APKBUILD
            echo $'\tgrep -n "adsp_mem" "$DTSI_FILE" || msg "No adsp_mem found!"' >> APKBUILD
            echo $'\tmsg "Lines containing 8b200000 in DTSI:"' >> APKBUILD
            echo $'\tgrep -n "8b200000" "$DTSI_FILE" || msg "No 8b200000 found!"' >> APKBUILD
            
            # 执行 sed 替换
            echo $'\tif grep -q "8b200000" "$DTSI_FILE"; then' >> APKBUILD
            echo $'\t\tmsg "REPLACING 8b200000 -> 91900000"' >> APKBUILD
            echo $'\t\tsed -i "s/0x8b200000/0x91900000/g" "$DTSI_FILE"' >> APKBUILD
            echo $'\t\tsed -i "s/memory@8b200000/memory@91900000/g" "$DTSI_FILE"' >> APKBUILD
            echo $'\t\tmsg "After sed - lines with 91900000:"' >> APKBUILD
            echo $'\t\tgrep -n "91900000" "$DTSI_FILE" || msg "STILL NOT FOUND!"' >> APKBUILD
            echo $'\telse' >> APKBUILD
            echo $'\t\terror "CRITICAL: 8b200000 not found in $DTSI_FILE"' >> APKBUILD
            echo $'\t\tmsg "Full file content (first 100 lines):"' >> APKBUILD
            echo $'\t\thead -n 100 "$DTSI_FILE"' >> APKBUILD
            echo $'\tfi' >> APKBUILD
            
            echo $'\tif grep -q "95700000" "$DTSI_FILE"; then' >> APKBUILD
            echo $'\t\tmsg "REPLACING 95700000 -> 95800000"' >> APKBUILD
            echo $'\t\tsed -i "s/0x95700000/0x95800000/g" "$DTSI_FILE"' >> APKBUILD
            echo $'\t\tsed -i "s/memory@95700000/memory@95800000/g" "$DTSI_FILE"' >> APKBUILD
            echo $'\telse' >> APKBUILD
            echo $'\t\terror "CRITICAL: 95700000 not found in $DTSI_FILE"' >> APKBUILD
            echo $'\tfi' >> APKBUILD
            
            # 最终验证
            echo $'\tmsg "========== FINAL VERIFICATION =========="' >> APKBUILD
            echo $'\tmsg "Checking for 91900000:"' >> APKBUILD
            echo $'\tgrep -n "91900000" "$DTSI_FILE"' >> APKBUILD
            echo $'\tif grep -q "91900000" "$DTSI_FILE"; then' >> APKBUILD
            echo $'\t\tmsg "SUCCESS: New address 91900000 confirmed in DTSI"' >> APKBUILD
            echo $'\telse' >> APKBUILD
            echo $'\t\terror "FAILED: 91900000 NOT found after sed!"' >> APKBUILD
            echo $'\t\treturn 1' >> APKBUILD
            echo $'\tfi' >> APKBUILD
            echo $'\tmsg "========== MEMORY MAP FIX END =========="' >> APKBUILD
            echo '}' >> APKBUILD
            sed -i '/default_prepare/a\	fix_memory_map' APKBUILD
          fi
          
          # 使用正则匹配任意 pkgrel 值，设置为更高的版本号强制重新编译
          sed -i 's/pkgrel=[0-9]*/pkgrel=20/' APKBUILD
          
          pmbootstrap checksum linux-postmarketos-qcom-msm8998
          
          # ccache 由 pmbootstrap 配置自动启用，不需要 --ccache 参数
          pmbootstrap --details-to-stdout build linux-postmarketos-qcom-msm8998 --force
          
          # 构建后显示 ccache 统计
          echo "=== ccache stats after kernel build ==="
          ccache -s

      - name: Build Rootfs with Docker (TWRP Zip)
        run: |
          set -o pipefail
          pmbootstrap install \
            --add docker,docker-compose,nano,htop,firmware-xiaomi-sagit,pd-mapper,tqftpserv,qrtr,rmtfs,msm-modem,ofono,android-tools \
            --password zhoutong \
            --android-recovery-zip
          
          # 注入固件
          FIRMWARE_URL="https://git.kernel.org/pub/scm/linux/kernel/git/firmware/linux-firmware.git/plain/ath10k/WCN3990/hw1.0/firmware-5.bin"
          wget -O /tmp/firmware-5.bin "$FIRMWARE_URL" || true
          
          pmbootstrap chroot -r -- mkdir -p /lib/firmware/ath10k/WCN3990/hw1.0/
          WORK_DIR=$(pmbootstrap config work)
          cp /tmp/firmware-5.bin "$WORK_DIR/chroot_rootfs_xiaomi-sagit/tmp/" || true
          pmbootstrap chroot -r -- cp /tmp/firmware-5.bin /lib/firmware/ath10k/WCN3990/hw1.0/firmware-5.bin || true
          
          # 服务启用
          pmbootstrap chroot -r -- rc-update add adbd default || true
          pmbootstrap chroot -r -- rc-update del sleep-inhibitor default || true

      - name: Export and Compress Images
        run: |
          pmbootstrap export
          mkdir -p output
          cp -r /tmp/postmarketOS-export/* output/

      - name: Upload Build Result
        uses: actions/upload-artifact@v4
        with:
          name: Mi6-Docker-OS-Final
          path: output/

      - name: Upload Boot Image (TWRP Flashable)
        uses: actions/upload-artifact@v4
        with:
          name: Mi6-Boot-Image-Fixed
          path: output/boot.img

      # ========== 核心修复：准备缓存阶段 ==========
      - name: Prepare Cache Permissions
        if: always()
        run: |
          echo "=== Cleaning up and fixing permissions for cache ==="
          
          # 1. 以非 root 身份运行 pmbootstrap shutdown（pmbootstrap 不允许 root 运行）
          pmbootstrap shutdown || true
          
          # 2. 强制卸载所有 chroot 内的挂载点
          echo "=== Force unmounting all chroot mounts ==="
          for CHROOT_DIR in /home/runner/.local/var/pmbootstrap/chroot_*; do
            if [ -d "$CHROOT_DIR" ]; then
              echo "Unmounting mounts in $CHROOT_DIR..."
              # 首先尝试卸载 /proc, /sys, /dev 等
              sudo umount -lf "$CHROOT_DIR/proc" 2>/dev/null || true
              sudo umount -lf "$CHROOT_DIR/sys" 2>/dev/null || true
              sudo umount -lf "$CHROOT_DIR/dev/pts" 2>/dev/null || true
              sudo umount -lf "$CHROOT_DIR/dev" 2>/dev/null || true
              # 卸载所有该目录下的挂载点
              mount | grep "$CHROOT_DIR" | awk '{print $3}' | sort -r | while read mp; do
                sudo umount -lf "$mp" 2>/dev/null || true
              done
            fi
          done
          
          # 3. 显示缓存目录的实际内容和大小（调试）
          echo "=== Cache directories before cleanup ==="
          echo "cache_git:"
          du -sh /home/runner/.local/var/pmbootstrap/cache_git 2>/dev/null || echo "Not found"
          echo "packages:"
          du -sh /home/runner/.local/var/pmbootstrap/packages 2>/dev/null || echo "Not found"
          ls -la /home/runner/.local/var/pmbootstrap/packages 2>/dev/null | head -5 || true
          echo "cache_distfiles:"
          du -sh /home/runner/.local/var/pmbootstrap/cache_distfiles 2>/dev/null || echo "Not found"
          
          # 4. 删除 chroot 目录（现在应该可以删除了）
          echo "=== Removing chroot directories ==="
          for CHROOT_DIR in /home/runner/.local/var/pmbootstrap/chroot_*; do
            if [ -d "$CHROOT_DIR" ]; then
              echo "Removing $CHROOT_DIR..."
              sudo rm -rf "$CHROOT_DIR" 2>&1 | tail -3 || true
            fi
          done
          
          # 5. 修改所有权（现在没有挂载点了，应该会成功）
          echo "=== Fixing ownership ==="
          sudo chown -R runner:runner /home/runner/.local/var/pmbootstrap/cache_git 2>&1 | tail -3 || true
          sudo chown -R runner:runner /home/runner/.local/var/pmbootstrap/packages 2>&1 | tail -3 || true
          sudo chown -R runner:runner /home/runner/.local/var/pmbootstrap/cache_distfiles 2>&1 | tail -3 || true
          sudo chown -R runner:runner /home/runner/.cache/ccache 2>&1 | tail -3 || true
          
          # 6. 最终检查缓存目录
          echo "=== Cache directories after cleanup ==="
          echo "cache_git:"
          du -sh /home/runner/.local/var/pmbootstrap/cache_git 2>/dev/null || echo "Not found"
          ls -la /home/runner/.local/var/pmbootstrap/cache_git 2>/dev/null | head -3 || true
          echo "packages:"
          du -sh /home/runner/.local/var/pmbootstrap/packages 2>/dev/null || echo "Not found"
          ls -la /home/runner/.local/var/pmbootstrap/packages 2>/dev/null | head -3 || true
          echo "Total pmbootstrap size (should be ~300MB+):"
          du -sh /home/runner/.local/var/pmbootstrap 2>/dev/null || echo "Not found"

