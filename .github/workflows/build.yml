name: Build Mi6 postmarketOS Docker Image

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: System Environment Setup
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 git openssl fastboot qemu-user-static qemu-system-arm wget
          # 2026年关键步骤：在宿主机注册 binfmt，确保能运行 arm64 指令
          sudo update-binfmts --enable qemu-aarch64

      - name: Install pmbootstrap from Source
        run: |
          git clone --depth 1 https://gitlab.com/postmarketOS/pmbootstrap.git
          # 将脚本目录加入 PATH
          echo "$(pwd)/pmbootstrap" >> $GITHUB_PATH
          # 设置软链接并确保可执行
          chmod +x $(pwd)/pmbootstrap/pmbootstrap.py
          sudo ln -sf $(pwd)/pmbootstrap/pmbootstrap.py /usr/local/bin/pmbootstrap

      - name: Initialize pmbootstrap (Non-Interactive)
        run: |
          # 2026版 pmbootstrap 支持更多预设参数，避免 read 阻塞
          pmbootstrap init --path /home/runner/.local/share/pmbootstrap <<EOF
          edge
          xiaomi
          sagit
          y
          user
          console
          systemd
          n
          EOF

      - name: Build Rootfs with Docker
        run: |
          # 强制开启 systemd 并预装 docker
          # --size=4096 确保有足够空间存放 docker 镜像
          pmbootstrap install --extra-packages docker,docker-compose,nano,htop --no-fde --size 4096

      - name: Export and Compress Images
        run: |
          pmbootstrap export
          mkdir -p output
          # 移动生成的镜像
          cp /tmp/postmarketOS-export/boot.img* output/ || true
          cp /tmp/postmarketOS-export/xiaomi-sagit.img* output/ || true

      - name: Upload Build Result
        uses: actions/upload-artifact@v4
        with:
          name: Mi6-Final-Docker-Image
          path: output/
