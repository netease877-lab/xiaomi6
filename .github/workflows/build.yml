name: Build Mi6 postmarketOS Docker Image

on:
  workflow_dispatch:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: System Environment Setup
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3 \
            git \
            openssl \
            fastboot \
            qemu-user-static \
            binfmt-support \
            wget \
            expect \
            ccache
          sudo update-binfmts --enable qemu-aarch64 || echo "binfmt already enabled"

      # 获取 pmaports 最新提交 Hash 用于缓存控制
      - name: Get pmaports Hash
        id: get-hash
        run: |
          HASH=$(git ls-remote https://gitlab.postmarketos.org/postmarketOS/pmaports.git main | awk '{print $1}')
          echo "pmaports_hash=$HASH" >> $GITHUB_OUTPUT

      # ========== 优化后的 pmbootstrap 缓存 ==========
      - name: Cache pmbootstrap work directory
        uses: actions/cache@v4
        with:
          path: |
            /home/runner/.local/var/pmbootstrap/cache_git
            /home/runner/.local/var/pmbootstrap/packages
            /home/runner/.local/var/pmbootstrap/cache_distfiles
          # 使用 pmaports 的 hash 作为 key，确保代码更新时能部分重用
          # v5: 强制清理之前被污染的缓存
          key: pmb-v5-${{ runner.os }}-${{ steps.get-hash.outputs.pmaports_hash }}
          restore-keys: |
            pmb-v5-${{ runner.os }}-

      # ========== ccache 编译缓存 ==========
      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: /home/runner/.cache/ccache
          # 加入周数，每周自动清理旧缓存，避免达到 10GB 限制
          key: ccache-v2-${{ runner.os }}-sagit-week${{ github.run_number }}
          restore-keys: |
            ccache-v2-${{ runner.os }}-sagit-week
            ccache-v2-${{ runner.os }}-sagit
            ccache-v2-${{ runner.os }}-

      - name: Setup ccache
        run: |
          mkdir -p /home/runner/.cache/ccache
          ccache --set-config=max_size=2G
          ccache --set-config=compression=true
          # 显示 ccache 统计
          echo "=== ccache stats before build ==="
          ccache -s

      # ========== 修复缓存恢复后的权限问题 ==========
      - name: Fix Restored Cache Permissions
        run: |
          echo "=== Fixing permissions for restored cache ==="
          # 如果缓存恢复了 packages 目录，需要确保 pmbootstrap 可以写入
          if [ -d /home/runner/.local/var/pmbootstrap/packages ]; then
            sudo chmod -R 777 /home/runner/.local/var/pmbootstrap/packages
            echo "Fixed packages directory permissions"
          fi
          if [ -d /home/runner/.local/var/pmbootstrap/cache_git ]; then
            sudo chmod -R 777 /home/runner/.local/var/pmbootstrap/cache_git
            echo "Fixed cache_git directory permissions"
          fi

      - name: Install pmbootstrap from Source
        run: |
          git clone --depth 1 https://gitlab.postmarketos.org/postmarketOS/pmbootstrap.git
          PMB_PATH=$(pwd)/pmbootstrap/pmbootstrap.py
          chmod +x $PMB_PATH
          sudo ln -sf $PMB_PATH /usr/local/bin/pmbootstrap
          pmbootstrap --version

      - name: Initialize pmbootstrap (Direct Config)
        run: |
          mkdir -p ~/.config ~/.local/var/pmbootstrap/cache_git
          touch build.log

          echo "=== Step 1: Setting up pmaports ===" >> build.log
          PMAPORTS_DIR=~/.local/var/pmbootstrap/cache_git/pmaports
          if [ -d "$PMAPORTS_DIR" ]; then
            echo "pmaports exists (from cache), updating..." >> build.log
            cd "$PMAPORTS_DIR" && git pull --rebase >> build.log 2>&1 || true
            cd -
          else
            echo "Cloning pmaports..." >> build.log
            git clone --depth=1 https://gitlab.postmarketos.org/postmarketOS/pmaports.git \
                "$PMAPORTS_DIR" >> build.log 2>&1
          fi
          
          echo "=== Step 1.5: Patching deviceinfo for RNDIS ===" >> build.log
          DEVICEINFO_PATH="$PMAPORTS_DIR/device/testing/device-xiaomi-sagit/deviceinfo"
          # 避免重复添加
          grep -q "rndis.usb0" "$DEVICEINFO_PATH" || echo 'deviceinfo_usb_network_function="rndis.usb0"' >> "$DEVICEINFO_PATH"
          
          echo "=== Step 2: Generating config file ===" >> build.log
          # 关键：在配置文件中指定 ccache 路径，pmbootstrap 会将其挂载到 chroot 内
          cat <<EOF > ~/.config/pmbootstrap_v3.cfg
          [pmbootstrap]
          device = xiaomi-sagit
          ui = console
          work = /home/runner/.local/var/pmbootstrap
          hostname = mi6
          user = user
          systemd = never
          extra_packages = docker,docker-compose,nano,htop
          is_default_channel = False
          aports = /home/runner/.local/var/pmbootstrap/cache_git/pmaports
          ccache = /home/runner/.cache/ccache
          EOF

          echo "8" > ~/.local/var/pmbootstrap/version

      - name: Patch and Rebuild Kernel
        run: |
          BUILD_LOG="$GITHUB_WORKSPACE/build.log"
          PMAPORTS=~/.local/var/pmbootstrap/cache_git/pmaports
          KERNEL_PKG_DIR="$PMAPORTS/device/testing/linux-postmarketos-qcom-msm8998"
          
          cd "$KERNEL_PKG_DIR"
          
          # 检查是否已经补丁过，防止重复注入
            if ! grep -q "fix_memory_map" APKBUILD; then
            echo '' >> APKBUILD
            echo '# === WiFi/ADSP/MPSS Memory Fix ===' >> APKBUILD
            echo 'fix_memory_map() {' >> APKBUILD
            echo $'\tmsg "========== MEMORY MAP FIX START =========="' >> APKBUILD
            echo $'\tmsg "Current directory: $(pwd)"' >> APKBUILD
            echo $'\tmsg "Listing DTS/DTSI files:"' >> APKBUILD
            echo $'\tfind . -name "*.dts*" -path "*qcom*" | head -20' >> APKBUILD
            
            # 查找 DTSI 文件
            echo $'\tlocal DTSI_FILE=$(find . -name "msm8998.dtsi" | head -n 1)' >> APKBUILD
            echo $'\tmsg "DTSI_FILE variable: $DTSI_FILE"' >> APKBUILD
            echo $'\tif [ -z "$DTSI_FILE" ]; then' >> APKBUILD
            echo $'\t\terror "ERROR: msm8998.dtsi NOT FOUND! Trying alternative search..."' >> APKBUILD
            echo $'\t\tfind . -name "*.dtsi" | grep -i msm8998' >> APKBUILD
            echo $'\t\treturn 1' >> APKBUILD
            echo $'\tfi' >> APKBUILD
            echo $'\tmsg "Found DTSI file at: $DTSI_FILE"' >> APKBUILD
            echo $'\tmsg "File size: $(wc -c < $DTSI_FILE) bytes"' >> APKBUILD
            
            # 调试：显示 DTSI 中包含 adsp_mem 的行
            echo $'\tmsg "Lines containing adsp_mem in DTSI:"' >> APKBUILD
            echo $'\tgrep -n "adsp_mem" "$DTSI_FILE" || msg "No adsp_mem found!"' >> APKBUILD
            echo $'\tmsg "Lines containing 8b200000 in DTSI:"' >> APKBUILD
            echo $'\tgrep -n "8b200000" "$DTSI_FILE" || msg "No 8b200000 found!"' >> APKBUILD
            
            # 执行 sed 替换
            echo $'\tif grep -q "8b200000" "$DTSI_FILE"; then' >> APKBUILD
            echo $'\t\tmsg "REPLACING 8b200000 -> 91900000"' >> APKBUILD
            echo $'\t\tsed -i "s/0x8b200000/0x91900000/g" "$DTSI_FILE"' >> APKBUILD
            echo $'\t\tsed -i "s/memory@8b200000/memory@91900000/g" "$DTSI_FILE"' >> APKBUILD
            echo $'\t\tmsg "After sed - lines with 91900000:"' >> APKBUILD
            echo $'\t\tgrep -n "91900000" "$DTSI_FILE" || msg "STILL NOT FOUND!"' >> APKBUILD
            echo $'\telse' >> APKBUILD
            echo $'\t\terror "CRITICAL: 8b200000 not found in $DTSI_FILE"' >> APKBUILD
            echo $'\t\tmsg "Full file content (first 100 lines):"' >> APKBUILD
            echo $'\t\thead -n 100 "$DTSI_FILE"' >> APKBUILD
            echo $'\tfi' >> APKBUILD
            
            echo $'\tif grep -q "95700000" "$DTSI_FILE"; then' >> APKBUILD
            echo $'\t\tmsg "REPLACING 95700000 -> 95800000"' >> APKBUILD
            echo $'\t\tsed -i "s/0x95700000/0x95800000/g" "$DTSI_FILE"' >> APKBUILD
            echo $'\t\tsed -i "s/memory@95700000/memory@95800000/g" "$DTSI_FILE"' >> APKBUILD
            echo $'\telse' >> APKBUILD
            echo $'\t\terror "CRITICAL: 95700000 not found in $DTSI_FILE"' >> APKBUILD
            echo $'\tfi' >> APKBUILD
            
            # 最终验证
            echo $'\tmsg "========== FINAL VERIFICATION =========="' >> APKBUILD
            echo $'\tmsg "Checking for 91900000:"' >> APKBUILD
            echo $'\tgrep -n "91900000" "$DTSI_FILE"' >> APKBUILD
            echo $'\tif grep -q "91900000" "$DTSI_FILE"; then' >> APKBUILD
            echo $'\t\tmsg "SUCCESS: New address 91900000 confirmed in DTSI"' >> APKBUILD
            echo $'\telse' >> APKBUILD
            echo $'\t\terror "FAILED: 91900000 NOT found after sed!"' >> APKBUILD
            echo $'\t\treturn 1' >> APKBUILD
            echo $'\tfi' >> APKBUILD
            echo $'\tmsg "========== MEMORY MAP FIX END =========="' >> APKBUILD
            echo '}' >> APKBUILD
            sed -i '/default_prepare/a\	fix_memory_map' APKBUILD
          fi
          
          # 使用正则匹配任意 pkgrel 值，设置为更高的版本号强制重新编译
          sed -i 's/pkgrel=[0-9]*/pkgrel=20/' APKBUILD
          
          pmbootstrap checksum linux-postmarketos-qcom-msm8998 2>&1 | tee -a "$BUILD_LOG"
          
          # 使用 --force 强制重新编译，确保 fix_memory_map 被执行
          pmbootstrap --details-to-stdout build linux-postmarketos-qcom-msm8998 --force --ccache 2>&1 | tee -a "$BUILD_LOG"
          
          # 构建后显示 ccache 统计
          echo "=== ccache stats after kernel build ==="
          ccache -s

      - name: Build Rootfs with Docker (TWRP Zip)
        run: |
          set -o pipefail
          pmbootstrap install \
            --add docker,docker-compose,nano,htop,firmware-xiaomi-sagit,pd-mapper,tqftpserv,qrtr,rmtfs,msm-modem,ofono,android-tools \
            --password zhoutong \
            --android-recovery-zip \
            2>&1 | tee -a build.log
          
          # 注入固件
          FIRMWARE_URL="https://git.kernel.org/pub/scm/linux/kernel/git/firmware/linux-firmware.git/plain/ath10k/WCN3990/hw1.0/firmware-5.bin"
          wget -O /tmp/firmware-5.bin "$FIRMWARE_URL" || true
          
          pmbootstrap chroot -r -- mkdir -p /lib/firmware/ath10k/WCN3990/hw1.0/
          WORK_DIR=$(pmbootstrap config work)
          cp /tmp/firmware-5.bin "$WORK_DIR/chroot_rootfs_xiaomi-sagit/tmp/" || true
          pmbootstrap chroot -r -- cp /tmp/firmware-5.bin /lib/firmware/ath10k/WCN3990/hw1.0/firmware-5.bin || true
          
          # 服务启用
          pmbootstrap chroot -r -- rc-update add adbd default || true
          pmbootstrap chroot -r -- rc-update del sleep-inhibitor default || true

      - name: Export and Compress Images
        run: |
          pmbootstrap export
          mkdir -p output
          cp -r /tmp/postmarketOS-export/* output/

      - name: Upload Build Result
        uses: actions/upload-artifact@v4
        with:
          name: Mi6-Docker-OS-Final
          path: output/

      - name: Upload Boot Image (TWRP Flashable)
        uses: actions/upload-artifact@v4
        with:
          name: Mi6-Boot-Image-Fixed
          path: output/boot.img

      # ========== 核心修复：准备缓存阶段 ==========
      - name: Prepare Cache Permissions
        if: always()
        run: |
          echo "=== Cleaning up and fixing permissions for cache ==="
          # 1. 卸载所有还在挂载的目录 (pmbootstrap 有时会残留挂载)
          sudo pmbootstrap shutdown || true
          # 2. 修改工作目录所有权，让 runner 用户可以打包它
          sudo chown -R runner:runner /home/runner/.local/var/pmbootstrap || true
          # 3. 修改 ccache 目录权限
          sudo chown -R runner:runner /home/runner/.cache/ccache || true
          # 4. 删除巨大的 chroot 目录以节省空间
          find /home/runner/.local/var/pmbootstrap -maxdepth 1 -name "chroot_*" -type d -exec sudo rm -rf {} + || true

      # 无论成功还是失败都上传日志
      - name: Upload Build Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: build.log
          if-no-files-found: warn
