name: Build Mi6 postmarketOS Docker Image

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: System Environment Setup
        run: |
          sudo apt-get update
          # 安装构建所需的系统工具以及 binfmt-support
          sudo apt-get install -y \
            python3 \
            git \
            openssl \
            fastboot \
            qemu-user-static \
            binfmt-support \
            wget
          
          # 注册 aarch64 模拟支持
          sudo update-binfmts --enable qemu-aarch64 || echo "binfmt already enabled"

      - name: Install pmbootstrap from Source (Correct Domain)
        run: |
          # 修复：使用官方新域名 gitlab.postmarketos.org
          git clone --depth 1 https://gitlab.postmarketos.org/postmarketOS/pmbootstrap.git
          
          # 设置软链接
          PMB_PATH=$(pwd)/pmbootstrap/pmbootstrap.py
          chmod +x $PMB_PATH
          sudo ln -sf $PMB_PATH /usr/local/bin/pmbootstrap
          
          # 验证版本
          pmbootstrap --version

      - name: Initialize pmbootstrap (Robust Config)
        run: |
          mkdir -p ~/.config/pmbootstrap
          
          # 1. Config Pre-sets (Skips Logic to minimize prompts)
          pmbootstrap config work /home/runner/.local/share/pmbootstrap
          pmbootstrap config channel edge
          pmbootstrap config user user
          pmbootstrap config device xiaomi-sagit
          pmbootstrap config ui console
          
          # 2. Keymap/Systemd/Other Prompts
          # Inputs:
          #   1. (Keymap) <Enter> for default
          #   2. (Confirm UI Extras) <Enter> for default (no)
          #   3. (Systemd) y <Enter>
          #   4. (Additional Options) <Enter> for default (no)
          #   5. (Timezone) <Enter> (default)
          #   6. (Locale) <Enter> (default)
          #   7. (Hostname) <Enter> (default)
          #   8. (SSH) <Enter> (default)
          printf "\n\ny\n\n\n\n\n\n" | pmbootstrap init

      - name: Build Rootfs with Docker
        run: |
          # --extra-packages 预装 docker,docker-compose 等
          # --size 4096 确保有 4GB 空间
          # --no-fde 关闭全盘加密
          pmbootstrap install --extra-packages docker,docker-compose,nano,htop --no-fde --size 4096

      - name: Export and Compress Images
        run: |
          # 导出镜像
          pmbootstrap export
          mkdir -p output
          # 兼容导出文件
          cp -r /tmp/postmarketOS-export/* output/

      - name: Upload Build Result
        uses: actions/upload-artifact@v4
        with:
          name: Mi6-Docker-OS-Final
          path: output/
