name: Build Mi6 postmarketOS Docker Image

on:
  workflow_dispatch:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: System Environment Setup
        run: |
          sudo apt-get update
          # 安装构建所需的系统工具以及 binfmt-support, expect
          sudo apt-get install -y \
            python3 \
            git \
            openssl \
            fastboot \
            qemu-user-static \
            binfmt-support \
            wget \
            expect
          
          # 注册 aarch64 模拟支持
          sudo update-binfmts --enable qemu-aarch64 || echo "binfmt already enabled"

      - name: Install pmbootstrap from Source (Correct Domain)
        run: |
          # 修复：使用官方新域名 gitlab.postmarketos.org
          git clone --depth 1 https://gitlab.postmarketos.org/postmarketOS/pmbootstrap.git
          
          # 设置软链接
          PMB_PATH=$(pwd)/pmbootstrap/pmbootstrap.py
          chmod +x $PMB_PATH
          sudo ln -sf $PMB_PATH /usr/local/bin/pmbootstrap
          
          # 验证版本
          pmbootstrap --version

      - name: Initialize pmbootstrap (Robust Expect)
        run: |
          mkdir -p ~/.config/pmbootstrap
          touch build.log
          
          # [Revision 19] 手动初始化环境 (Config + Pmaports)
          # 1. 手动创建配置文件，绕过 config 命令的 "Run init first" 限制
          mkdir -p ~/.config
          echo "[pmbootstrap]" > ~/.config/pmbootstrap_v3.cfg
          
          # 2. 手动克隆 pmaports，确保 init 能直接找到设备
          mkdir -p ~/.local/var/pmbootstrap/cache_git
          echo "Cloning pmaports..." >> build.log
          git clone --depth=1 https://gitlab.postmarketos.org/postmarketOS/pmaports.git ~/.local/var/pmbootstrap/cache_git/pmaports >> build.log 2>&1
          
          # 3. 验证环境 (Pull 应成功/跳过)
          echo "Executing: pmbootstrap pull" >> build.log
          pmbootstrap pull >> build.log 2>&1 || echo "pmbootstrap pull failed" >> build.log

          # 生成自动化交互脚本
          cat <<EOF > init.expect
          set timeout 300
          spawn pmbootstrap init
          
          # 处理所有可能的提问
          # 开启 Expect 内部调试日志
          exp_internal 1

          expect {
              # [Revision 16] 回归 Edge 分支并强化稳定性:
              # 1. 确认 sagit 是 Testing 设备，Edge 分支支持最完善。
              #    之前的 "Device not found" 是因为 pmaports 没更新 (已由 pmbootstrap pull 修复)。
              # 2. 保持 "Create new device port" 的熔断机制 (Exit 1)，防止脚本挂起。

              # --- High Priority ---
              -re {Provider.*:} { send "\r"; exp_continue }
              -re {Kernel.*:}   { send "\r"; exp_continue }

              # Work path & pmaports
              -re {Work path.*:} { send "\r"; exp_continue }
              -re {pmaports.*:} { send "\r"; exp_continue }
              
              # --- Dynamic Wizard Intercepts (Failure modes) ---
              # 匹配 "Do you want to create a new device port?"
              # 必须直接 exit 1 (Fail Fast)，让 CI 报错，而不是挂起。
              -re {.*create a new device port.*:} { 
                  puts "ERROR: Device not found in pmaports! Aborting."; 
                  exit 1 
              }
              -re {Type\?.*:} { send "mainline\r"; exp_continue }

              # --- Standard Prompts ---

              # 使用 Edge 分支 (Testing 设备首选)
              -re {Channel.*:} { send "edge\r"; exp_continue }
              -re {Vendor.*:} { send "xiaomi\r"; exp_continue }
              -re {Device codename.*:} { send "sagit\r"; exp_continue }
              -re {User interface.*:} { send "console\r"; exp_continue }

              # Systemd
              -re {Install systemd.*:} { send "\r"; exp_continue }

              # Additional Options
              -re {Change them.*:} { send "n\r"; exp_continue }

              # Specific options
              -re {Extra space.*:} { send "\r"; exp_continue }
              -re {Boot size.*:} { send "\r"; exp_continue }
              -re {Jobs.*:} { send "\r"; exp_continue }
              -re {Ccache size.*:} { send "\r"; exp_continue }
              -re {Sudo timer.*:} { send "\r"; exp_continue }
              -re {Change mirror.*:} { send "\r"; exp_continue }
              
              # Misc Setup
              -re {Use this timezone.*:} { send "\r"; exp_continue }
              -re {Locale.*:} { send "\r"; exp_continue }
              -re {Device hostname.*:} { send "\r"; exp_continue }
              -re {SSH keys.*:} { send "\r"; exp_continue }
              -re {Keymap.*:} { send "\r"; exp_continue }
              -re {Enable this package.*:} { send "\r"; exp_continue }
              
              # Zap chroots confirm
              -re {Zap existing chroots.*:} { send "y\r"; exp_continue }

              # 通用兜底 (去掉 \s*$ 锚点)
              -re {]:} { send "\r"; exp_continue }

              timeout { puts "Expect timeout!"; exit 1 }
              eof
          }
          EOF
          
          # 执行脚本并捕获日志 (使用 set -o pipefail 确保错误不仅被记录还能传导)
          set -o pipefail
          (
            chmod +x init.expect
            expect init.expect
          ) 2>&1 | tee -a build.log

      - name: Build Rootfs with Docker
        run: |
          set -o pipefail
          # --extra-packages 预装 docker,docker-compose 等
          # --size 4096 确保有 4GB 空间
          # --no-fde 关闭全盘加密
          pmbootstrap install --extra-packages docker,docker-compose,nano,htop --no-fde --size 4096 2>&1 | tee -a build.log

      - name: Upload Build Log on Failure
        if: failure()
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # 1. 先提交本地修改 (解决 unstaged changes 错误)
          git add --force build.log
          git commit -m "ci: build failure log [skip ci]"
          
          # 2. 再拉取远程更新 (rebase)
          git pull --rebase
          
          # 3. 推送
          git push

      - name: Export and Compress Images
        run: |
          # 导出镜像
          pmbootstrap export
          mkdir -p output
          # 兼容导出文件
          cp -r /tmp/postmarketOS-export/* output/

      - name: Upload Build Result
        uses: actions/upload-artifact@v4
        with:
          name: Mi6-Docker-OS-Final
          path: output/
